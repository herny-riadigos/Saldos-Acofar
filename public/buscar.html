<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscar Semanas - Riadigos</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- ======== CABECERA ======== -->
  <header>
    <div class="fecha" id="fecha"></div>
    <button class="btn-riadigos" onclick="irPrincipal()">Riadigos*</button>
  </header>

  <!-- ======== BOT√ìN VOLVER ======== -->
  <div class="buscar-container">
    <button class="btn-buscar" onclick="irPrincipal()">‚¨Ö Volver</button>
  </div>

  <!-- ======== CONTENIDO CENTRAL ======== -->
  <main>
    <div class="contenido">
      <h2 class="titulo-principal">Buscar registros de cierres semanales</h2>

      <!-- üß≠ FILTROS -->
      <div class="filtros">
        <label>Sucursal:
          <select id="sucursalSelect">
            <option value="">Todas</option>
            <option>JBJ</option>
            <option>ALEM</option>
            <option>FARMACIA MESA</option>
            <option>GASCON</option>
            <option>DIAGONAL</option>
            <option>MRL</option>
            <option>GRAMA</option>
            <option>ORTEGA</option>
            <option>RIMATU</option>
            <option>RM</option>
            <option>GUEMES Y SHOPPING</option>
            <option>SAN MARTIN</option>
          </select>
        </label>

        <label>Semana:
          <input type="date" id="semanaInput" />
        </label>

        <label>Resumen:
          <input type="text" id="resumenInput" placeholder="Ej: 2520">
        </label>

        <button id="btnBuscar" class="btn-buscar">üîç Buscar</button>
      </div>

      <!-- üßæ RESULTADOS -->
      <div id="resultados" class="resultados">
        <p class="placeholder">üîé No hay resultados para mostrar.</p>
      </div>
    </div>
  </main>

  <!-- üî• Firebase COMPATIBLE SDK (v9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    // üîß Configuraci√≥n Firebase (ya configurada en tu proyecto)
    const firebaseConfig = {
      apiKey: "AIzaSyBy1azVUd_Js7T8m4BMmVxu1gHRc4OsKw",
      authDomain: "gestion-horarios-riadigos.firebaseapp.com",
      projectId: "gestion-horarios-riadigos",
      storageBucket: "gestion-horarios-riadigos.appspot.com",
      messagingSenderId: "647794385698",
      appId: "1:647794385698:web:f643aeea827de6947db7b7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script src="utilidades.js"></script>

  <script>
    /****************************************************
     * üìÖ CALCULAR RANGO SEMANAL (lunes a domingo)
     ****************************************************/
    function obtenerRangoSemana(fechaSeleccionada) {
      const fecha = new Date(fechaSeleccionada);
      const diaSemana = fecha.getDay(); // 0=domingo, 1=lunes...
      const lunes = new Date(fecha);
      lunes.setDate(fecha.getDate() - ((diaSemana + 6) % 7));
      const domingo = new Date(lunes);
      domingo.setDate(lunes.getDate() + 6);
      return { lunes, domingo };
    }

    /****************************************************
     * üîç FILTRAR REGISTROS LOCALSTORAGE
     ****************************************************/
    function filtrarRegistros() {
      const registros = JSON.parse(localStorage.getItem("cierresRiadigos") || "[]");
      const sucursal = document.getElementById("sucursalSelect").value.trim();
      const resumen = document.getElementById("resumenInput").value.trim();
      const fecha = document.getElementById("semanaInput").value;

      let filtrados = registros;

      // Filtro por sucursal
      if (sucursal) filtrados = filtrados.filter(r => r.sucursal === sucursal);

      // Filtro por resumen
      if (resumen) filtrados = filtrados.filter(r => r.resumen.includes(resumen));

      // Filtro por semana (rango lunes-domingo)
      if (fecha) {
        const { lunes, domingo } = obtenerRangoSemana(fecha);
        const inicio = lunes.getTime();
        const fin = domingo.getTime();

        filtrados = filtrados.filter(r => {
          const [dia, mes, a√±o] = r.semana.split(/[\/\-]/).map(Number);
          const fechaRegistro = new Date(a√±o, mes - 1, dia).getTime();
          return fechaRegistro >= inicio && fechaRegistro <= fin;
        });

        console.log(`Buscando registros del ${lunes.toLocaleDateString("es-AR")} al ${domingo.toLocaleDateString("es-AR")}`);
      }

      mostrarResultados(filtrados);
    }

    /****************************************************
     * üßæ MOSTRAR RESULTADOS
     ****************************************************/
    function mostrarResultados(lista) {
      const contenedor = document.getElementById("resultados");
      contenedor.innerHTML = "";

      if (lista.length === 0) {
        contenedor.innerHTML = `<p class="placeholder">‚ùå No se encontraron registros.</p>`;
        return;
      }

      lista.forEach((r, i) => {
        const div = document.createElement("div");
        div.className = "card-resultado";
        div.innerHTML = `
          <div class="cabecera-card" onclick="toggleDetalle(${i})">
            <strong>${r.sucursal}</strong> ‚Äî Semana: ${r.semana} ‚Äî Resumen: ${r.resumen}
            <span class="fecha-guardado">(${r.fechaGuardado})</span>
          </div>
          <div class="detalle-card" id="detalle_${i}">
            <table>
              <thead>
                <tr><th>D√≠a</th><th>Clover</th><th>Posnet</th><th>Total</th></tr>
              </thead>
              <tbody>
                ${r.datos.map(f => `
                  <tr>
                    <td>${f.dia}</td>
                    <td>${f.clover.toLocaleString("es-AR", { style: "currency", currency: "ARS" })}</td>
                    <td>${f.posnet.toLocaleString("es-AR", { style: "currency", currency: "ARS" })}</td>
                    <td>${f.total.toLocaleString("es-AR", { style: "currency", currency: "ARS" })}</td>
                  </tr>`).join("")}
                <tr class="fila-total">
                  <td><strong>Total</strong></td>
                  <td>${r.totales.clover.toLocaleString("es-AR", { style: "currency", currency: "ARS" })}</td>
                  <td>${r.totales.posnet.toLocaleString("es-AR", { style: "currency", currency: "ARS" })}</td>
                  <td>${r.totales.general.toLocaleString("es-AR", { style: "currency", currency: "ARS" })}</td>
                </tr>
              </tbody>
            </table>
          </div>`;
        contenedor.appendChild(div);
      });
    }

    function toggleDetalle(i) {
      const el = document.getElementById("detalle_" + i);
      el.style.display = el.style.display === "block" ? "none" : "block";
    }

    // Escuchar clic del bot√≥n
    document.getElementById("btnBuscar").addEventListener("click", filtrarRegistros);

    // Mostrar todos al cargar
    filtrarRegistros();
  </script>
</body>
</html>
